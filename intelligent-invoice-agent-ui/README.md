# Invoice Agent - Complete System Guide

## System Architecture

The Invoice Agent is a comprehensive system with three main components:
- **Frontend UI** (React/Next.js) - Port 3000
- **Spring Boot API** - Port 8081 (Invoice processing & SSE streaming)
- **Python Vector DB API** - Port 8000 (Vector database management)

## How to Run

1. **Install Dependencies**
   ```bash
   npm install
   ```

2. **Start Development Server**
   ```bash
   npm run dev
   ```

3. **Open in Browser**
   Navigate to [http://localhost:3000](http://localhost:3000)

## Application Features

### Tab 1: Invoice Analysis

#### Screen 1: Upload Invoice
1. Click the upload area or drag & drop a file (PDF, PNG, JPG, XLSX)
2. File preview will appear with name and size
3. Click "Start Processing" button (enabled only when file is selected)
4. Click the X icon to remove the selected file

#### Screen 2: Processing
1. Watch the animated workflow progress through 3 stages:
   - **OCR Extraction** - Extracting text from invoice
   - **Data Validation** - Validating extracted data
   - **AI Analysis** - Generating insights
2. Progress bar shows overall completion percentage
3. Each step animates with pulse effect when active
4. Completed steps show green checkmark

#### Screen 3: Results
1. **Validation Badge** - Shows ✓ Valid or ✗ Invalid status
2. **Recommendation Badge** - Shows AI recommendation (Approve/Reject)
3. **Extracted Data** - View invoice number, date, vendor, amount
4. **Line Items** - See itemized list with quantities and prices
5. **AI Insights & Analysis** - AI-generated insights and recommendations
6. **Duplicate Detection** - Red alert box if duplicate found with similarity score
7. **Submit Payment** - Button disabled for duplicates
8. **JSON Viewer** - Raw JSON data in formatted view
9. **Download JSON** - Downloads the JSON file
10. **Process Another** - Returns to upload screen

### Tab 2: Vector DB Management

1. **Database Overview** - Shows total invoices, active invoices, and unique hashes
2. **Invoice List** - Table view of all stored invoices with:
   - Invoice ID (with copy functionality)
   - Content preview
   - Metadata and hash information
   - Status indicators
   - Delete actions
3. **Bulk Operations**:
   - **Refresh** - Reload data from vector database
   - **Clear All** - Remove all invoices (with confirmation)
4. **Real-time Updates** - Auto-refreshes when new invoices are processed

### Tab 3: Stream Transport MCP Server

1. **Real-time Data Stream** - Live customer data from Spring Boot SSE endpoint
2. **Auto-refresh** - Connects via Server-Sent Events (SSE)
3. **Data Table** - Shows ID, Name, Email, City, Balance
4. **Statistics Dashboard** - Total records, total balance, unique cities
5. **Live Updates** - Data appears in real-time as generated by backend

## API Integration

### Spring Boot API (Port 8081)
- **POST** `/api/v1/invoice-agent/upload` - Invoice processing
- **GET** `/api/v1/stream` - SSE stream for real-time data

### Python Vector DB API (Port 8000)
- **GET** `/vector-db/invoices` - List all invoices
- **DELETE** `/vector-db/invoice/{id}` - Delete specific invoice
- **DELETE** `/vector-db/clear?confirm=true` - Clear all invoices

## Features Included

✅ **Invoice Processing**
- Drag & drop file upload
- Multi-format support (PDF, XLSX, PNG, JPG)
- Animated processing workflow
- AI-powered duplicate detection
- Payment workflow with duplicate blocking

✅ **Vector Database Management**
- Real-time database monitoring
- Individual and bulk delete operations
- Metadata visualization
- Auto-refresh capabilities

✅ **Real-time Data Streaming**
- Server-Sent Events (SSE) integration
- Live data table updates
- Statistics dashboard
- Automatic reconnection

✅ **UI/UX Features**
- Responsive design
- Smooth transitions and animations
- JSON viewer with syntax highlighting
- Download functionality
- Error handling and user feedback

## Backend Requirements

### Spring Boot Configuration
```java
// CORS Configuration
@CrossOrigin(origins = {"http://localhost:3000"})

// SSE Endpoint
@GetMapping(value = "/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public Flux<ServerSentEvent<String>> streamData() {
    return dataGenerator.stream()
            .map(data -> ServerSentEvent.<String>builder()
                    .data(data)
                    .build());
}
```

### Python API Configuration
```python
# CORS Middleware
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_methods=["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    allow_headers=["*"]
)
```

## Troubleshooting

### Common Issues
1. **CORS Errors** - Ensure both Spring Boot and Python APIs have proper CORS configuration
2. **SSE Not Working** - Check Spring Boot returns `Flux<ServerSentEvent<String>>` not `Flux<String>`
3. **Vector DB Connection** - Verify Python API is running on port 8000
4. **File Upload Issues** - Check Spring Boot accepts multipart/form-data

### Network Tab Debugging
- Monitor API calls in browser Developer Tools
- Check response status codes and headers
- Verify SSE connection in Network tab
- Look for CORS preflight OPTIONS requests
